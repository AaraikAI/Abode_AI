# Logstash Pipeline Configuration for Abode AI

input {
  # TCP input for application logs
  tcp {
    port => 5000
    codec => json_lines
    tags => ["app"]
  }

  # UDP input for metrics
  udp {
    port => 5000
    codec => json
    tags => ["metrics"]
  }

  # HTTP input for webhooks
  http {
    port => 8080
    codec => json
    tags => ["webhook"]
  }
}

filter {
  # Parse timestamp
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }
  }

  # Add environment metadata
  mutate {
    add_field => {
      "[@metadata][environment]" => "${ENVIRONMENT:development}"
      "[@metadata][service]" => "abode-ai"
    }
  }

  # Parse application logs
  if "app" in [tags] {
    # Extract log level
    grok {
      match => { "message" => "%{LOGLEVEL:log_level}" }
    }

    # Parse JSON if present
    if [message] =~ /^\{.*\}$/ {
      json {
        source => "message"
        target => "parsed"
      }
    }
  }

  # Process metrics
  if "metrics" in [tags] {
    mutate {
      add_tag => ["performance"]
    }
  }

  # Process errors
  if [level] == "error" or [log_level] == "ERROR" {
    mutate {
      add_tag => ["error"]
    }
  }

  # Extract user information
  if [user_id] {
    mutate {
      add_field => { "[@metadata][user_id]" => "%{user_id}" }
    }
  }

  # Extract project information
  if [project_id] {
    mutate {
      add_field => { "[@metadata][project_id]" => "%{project_id}" }
    }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
    index => "abode-ai-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # Debug output (remove in production)
  if [@metadata][debug] == "true" {
    stdout {
      codec => rubydebug
    }
  }
}
